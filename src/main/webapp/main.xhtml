<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:p="http://primefaces.org/ui" xmlns:f="http://java.sun.com/jsf/core">
<h:head>
    <title>Main page</title>
    <meta charset="UTF-8"/>
    <h:outputStylesheet name="css/main.css"/>
</h:head>
<h:body>
    <f:metadata>
        <f:event type="preRenderView" listener="#{pointBean.updatePoints}"/>
    </f:metadata>


    <h:form id="mainForm">
        <div class="window">
            <p:outputPanel id="coordinatePanelWrapper"
                           style="position: relative; margin-top: 10px; margin-left: 180px;">
                <p:outputPanel id="coordinatePanel" style="position: absolute; width: 400px; height: 400px;">
                    <svg width="400" height="400" onclick="drawPoint(event)">
                        <line x1="0" y1="200" x2="400" y2="200" style="stroke: black; stroke-width: 2"/>
                        <line x1="200" y1="0" x2="200" y2="400" style="stroke: black; stroke-width: 2"/>
                        <polygon points="400,200 390,195 390,205" style="fill: black"/>
                        <polygon points="200,0 195,10 205,10" style="fill: black"/>
                        <line x1="80" y1="195" x2="80" y2="205" style="stroke: black; stroke-width: 2"/>
                        <line x1="140" y1="195" x2="140" y2="205" style="stroke: black; stroke-width: 2"/>
                        <line x1="260" y1="195" x2="260" y2="205" style="stroke: black; stroke-width: 2"/>
                        <line x1="320" y1="195" x2="320" y2="205" style="stroke: black; stroke-width: 2"/>
                        <text id="Rx" x="75" y="220" font-size="12">-R</text>
                        <text id="R/2x" x="135" y="220" font-size="12">-R/2</text>
                        <text id="-R/2x" x="255" y="220" font-size="12">R/2</text>
                        <text id="-Rx" x="315" y="220" font-size="12">R</text>
                        <line x1="195" y1="80" x2="205" y2="80" style="stroke: black; stroke-width: 2"/>
                        <line x1="195" y1="140" x2="205" y2="140" style="stroke: black; stroke-width: 2"/>
                        <line x1="195" y1="260" x2="205" y2="260" style="stroke: black; stroke-width: 2"/>
                        <line x1="195" y1="320" x2="205" y2="320" style="stroke: black; stroke-width: 2"/>
                        <text id="Ry" x="180" y="85" font-size="12">R</text>
                        <text id="R/2y" x="180" y="145" font-size="12">R/2</text>
                        <text id="-R/2y" x="180" y="265" font-size="12">-R/2</text>
                        <text id="-Ry" x="180" y="325" font-size="12">-R</text>
                        <path d="M200,200 L200,80 A140,140 0 0,1 320,200 Z"
                              style="fill: rgba(225, 217, 206, 0.5); stroke: black; stroke-width: 2"/>
                        <polygon points="260,200 200,200 200,260"
                                 style="fill: rgba(225, 217, 206, 0.5); stroke: black; stroke-width: 2"/>
                        <polygon points="80,200 200,200 200,260 80,260"
                                 style="fill: rgba(225, 217, 206, 0.5); stroke: black; stroke-width: 2"/>
                    </svg>
                </p:outputPanel>
            </p:outputPanel>

            <div class="inputFields">
                <div class="select">
                    <h:outputLabel value="X:  "/>
                    <p:selectOneMenu id="xSelect" value="#{pointBean.x}" styleClass="slct">
                        <f:selectItem itemValue="-5" itemLabel="-5"/>
                        <f:selectItem itemValue="-4" itemLabel="-4"/>
                        <f:selectItem itemValue="-3" itemLabel="-3"/>
                        <f:selectItem itemValue="-2" itemLabel="-2"/>
                        <f:selectItem itemValue="-1" itemLabel="-1"/>
                        <f:selectItem itemValue="0" itemLabel="0"/>
                        <f:selectItem itemValue="1" itemLabel="1"/>
                    </p:selectOneMenu>
                </div>
                <div class="input">
                    <h:outputLabel value="Y: ">
                        <h:inputText id="y" maxlength="4" value="#{pointBean.y}" styleClass="inpt">
                            <f:validateDoubleRange minimum="-3" maximum="3"/>
                            <p:message for="y"/>
                        </h:inputText>
                        <p:watermark for="y" value="Введите значение от -3 до 3"/>
                    </h:outputLabel>
                </div>
                <div class="select">
                    <h:outputLabel value="R: "/>
                    <p:selectOneMenu id="rSelect" widgetVar="rVar" value="#{pointBean.r}" styleClass="slct"
                                     onchange="changeR(this.value)">
                        <f:selectItem itemValue="1" itemLabel="1"/>
                        <f:selectItem itemValue="1.5" itemLabel="1.5"/>
                        <f:selectItem itemValue="2" itemLabel="2"/>
                        <f:selectItem itemValue="2.5" itemLabel="2.5"/>
                        <f:selectItem itemValue="3" itemLabel="3"/>
                    </p:selectOneMenu>
                </div>
                <div id="alerts"> </div>
                <div class="err-mess">
                    <p:message for="y" styleClass="error-message" showSummary="true" showDetail="false"
                               style="color: #462904; background-color: #cab08f; border-radius: 5px;"/>
                </div>
            </div>
            <div class="button-container">
                <p:commandButton value="Submit" action="#{pointBean.savePoint()}" ajax="false"
                                 oncomplete="location.reload()"/>
                <p:commandButton value="Reset" action="#{pointBean.deletePoints()}" ajax="false" onclick="clearSVG()"/>
            </div>
        </div>
    </h:form>
    <h:dataTable value="#{pointBean.receivePoints()}" var="check">
        <h:column>
            <f:facet name="header">X</f:facet>
            <h:outputText value="#{check.x}"/>
        </h:column>
        <h:column>
            <f:facet name="header">Y</f:facet>
            <h:outputText value="#{check.y}"/>
        </h:column>
        <h:column>
            <f:facet name="header">R</f:facet>
            <h:outputText value="#{check.r}"/>
        </h:column>
        <h:column>
            <f:facet name="header">Result</f:facet>
            <h:outputText value="#{check.result}"/>
        </h:column>
        <h:column>
            <f:facet name="header">Time</f:facet>
            <h:outputText value="#{check.checkDate}"/>
        </h:column>
    </h:dataTable>
    <div class="back">
        <h:button value="Back" outcome="toIndex" styleClass="back-button"/>
    </div>
</h:body>
<p:remoteCommand name="send" action="#{pointBean.sendJsPoint}"/>
<script type="text/javascript">
    let flag;
    let globalR = 1;
    alerts = document.getElementById('alerts');
    const alertDiv = document.createElement('div');
    window.onload = function () {
        getPoint();
    };
    function getPoint() {
        let jsonString = '#{pointBean.receiveJsonPoints()}';
        let points = JSON.parse(jsonString);
        points.forEach(point => {
            const {x, y, r} = point;
            const svg = document.querySelector('svg');
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            const width = 400;
            const height = 400;
            const centerX = width / 2;
            const centerY = height / 2;
            const cx = centerX + x * (width / (3.3 * r));
            const cy = centerY - y * (height / (3.3 * r));
            check(x, y, r);
            let e = 0.00000000000001;
            if (cx >= -e &amp;&amp; cx &lt;= width + e &amp;&amp; cy >= -e &amp;&amp; cy &lt;= height + e) {
                setRound(circle, cx, cy, r, flag);
                svg.appendChild(circle);
            } else {
                showAlert("Точка не попадает в координатную ось");
            }

        });
    }

    function clearSVG() {
        const svg = document.querySelector('svg');
        const circles = svg.querySelectorAll("circle");
        circles.forEach(circle => {
            svg.removeChild(circle);
        });
    }

    const showAlert = message => {
        alertDiv.textContent = message;
        alerts.appendChild(alertDiv);
        setTimeout(() => {
            alertDiv.remove();
        }, 2000);
    }

    function check(x, y, r) {
        if ((x >= 0 &amp;&amp; y &lt;= 0 &amp;&amp; x &lt;= r / 2 &amp;&amp; y >= -r / 2) ||
            (x &lt;= 0 &amp;&amp; y &lt;= 0 &amp;&amp; x >= -r &amp;&amp; y >= -r / 2) ||
            (x >= 0 &amp;&amp; y >= 0 &amp;&amp; x &lt;= r &amp;&amp; y &lt;= r &amp;&amp; (Math.pow(x, 2) + Math.pow(y, 2) &lt;= Math.pow(r, 2)))) {
            flag = "true";
        } else {
            flag = "false";
        }
    }

    function setRound(circle, cx, cy, r, flag) {
        circle.setAttribute("cx", cx);
        circle.setAttribute("cy", cy);
        circle.setAttribute("r", '5');
        if (flag === "true") {
            circle.setAttribute("fill", "beige");
        } else {
            circle.setAttribute("fill", "black");
        }
    }

    function getXY(svg, event) {
        const rect = svg.getBoundingClientRect();
        return {x: event.clientX - rect.left, y: event.clientY - rect.top};
    }

    function changeR(r) {
        globalR = r || 1;
        const elements = {
            "Ry": globalR,
            "R/2y": globalR / 2,
            "-R/2y": -globalR / 2,
            "-Ry": -globalR,
            "Rx": -globalR,
            "R/2x": -globalR / 2,
            "-R/2x": globalR / 2,
            "-Rx": globalR
        };

        for (const id in elements) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = elements[id] ? elements[id].toString() : "";
            }
        }
    }

    function drawPoint(event) {
        const r = globalR;
        const svgDraw = document.querySelector('svg');
        const point = getXY(svgDraw, event);
        const xPoint = point.x;
        const yPoint = point.y;

        const existingPoints = svgDraw.querySelectorAll('circle');
        existingPoints.forEach((point) => {
            point.parentNode.removeChild(point);
        });
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        setRound(circle, xPoint, yPoint, r);
        svgDraw.appendChild(circle)
        const tempX = point.x - 200;
        const tempY = 200 - point.y;
        const temp = 120 / r;
        const newX = (tempX / temp).toFixed(1);
        const newY = (tempY / temp).toFixed(1);
        sendPoints(newX, newY, r);
        check(newX, newY, r);
        setRound(circle, xPoint, yPoint, r, flag);
    }

    function sendPoints(x, y, r) {
        send([{name: "x", value: x}, {name: "y", value: y}, {name: "r", value: r}]);
        setTimeout(function () {
            location.reload();
        }, 1000);
    }

</script>
</html>